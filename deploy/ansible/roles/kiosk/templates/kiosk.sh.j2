#!/bin/bash
set -e

# Load environment
if [ -f /home/pi/.kiosk-env ]; then
    source /home/pi/.kiosk-env
fi

# Configuration with defaults
CALENDAR_URL="${CALENDAR_URL:-{{ calendar_url }}}"
KIOSK_ROTATION="${KIOSK_ROTATION:-{{ kiosk_rotation }}}"

export DISPLAY=:0

# Wait for X server
echo "Waiting for X server..."
while ! xdpyinfo >/dev/null 2>&1; do
    sleep 1
done
echo "X server ready"

# Disable screen saver and power management
xset s off
xset s noblank
xset -dpms

# Hide cursor after 3 seconds of inactivity
unclutter -idle 3 -root &

# Rotate display if needed
if [ "$KIOSK_ROTATION" != "0" ]; then
    echo "Rotating display: $KIOSK_ROTATION"
    xrandr --output HDMI-1 --rotate $KIOSK_ROTATION 2>/dev/null || true
    xrandr --output DSI-1 --rotate $KIOSK_ROTATION 2>/dev/null || true
fi

# Clear Chromium crash flags
sed -i 's/"exited_cleanly":false/"exited_cleanly":true/' \
    /home/pi/.config/chromium/Default/Preferences 2>/dev/null || true
sed -i 's/"exit_type":"Crashed"/"exit_type":"Normal"/' \
    /home/pi/.config/chromium/Default/Preferences 2>/dev/null || true

echo "Starting Chromium kiosk mode..."
echo "URL: $CALENDAR_URL"

# Start Chromium in kiosk mode
exec chromium-browser \
    --kiosk \
    --noerrdialogs \
    --disable-infobars \
    --disable-session-crashed-bubble \
    --disable-restore-session-state \
    --disable-component-update \
    --disable-background-networking \
    --disable-sync \
    --disable-translate \
    --disable-features=TranslateUI \
    --disable-default-apps \
    --disable-extensions \
    --disable-hang-monitor \
    --disable-popup-blocking \
    --disable-prompt-on-repost \
    --disable-background-timer-throttling \
    --disable-renderer-backgrounding \
    --disable-backgrounding-occluded-windows \
    --autoplay-policy=no-user-gesture-required \
    --check-for-update-interval=31536000 \
    --enable-features=OverlayScrollbar \
    --enable-gpu-rasterization \
    --enable-zero-copy \
    --ignore-gpu-blocklist \
    --start-fullscreen \
    --start-maximized \
    --window-position=0,0 \
    --user-data-dir=/home/pi/.config/chromium-kiosk \
    "$CALENDAR_URL"
