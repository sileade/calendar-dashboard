#!/bin/bash
# Health check script for Calendar Kiosk
# Generated by Ansible

LOG_PREFIX="[$(date '+%Y-%m-%d %H:%M:%S')]"

# Check if Chromium is running
if ! pgrep -x "chromium" > /dev/null; then
    echo "$LOG_PREFIX ERROR: Chromium not running, restarting kiosk..."
    systemctl restart calendar-kiosk
    exit 1
fi

# Check display
if ! DISPLAY=:0 xdpyinfo > /dev/null 2>&1; then
    echo "$LOG_PREFIX ERROR: Display not available"
    exit 1
fi

# Check network connectivity
if ! ping -c 1 -W 5 8.8.8.8 > /dev/null 2>&1; then
    echo "$LOG_PREFIX WARNING: No internet connectivity"
fi

# Check disk space
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | tr -d '%')
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "$LOG_PREFIX WARNING: Disk usage above 90% ($DISK_USAGE%)"
fi

# Check memory
MEM_USAGE=$(free | awk 'NR==2 {printf "%.0f", $3/$2 * 100}')
if [ "$MEM_USAGE" -gt 90 ]; then
    echo "$LOG_PREFIX WARNING: Memory usage above 90% ($MEM_USAGE%)"
fi

# Check CPU temperature (Raspberry Pi specific)
if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
    TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
    TEMP_C=$((TEMP / 1000))
    if [ "$TEMP_C" -gt 80 ]; then
        echo "$LOG_PREFIX WARNING: CPU temperature above 80°C ($TEMP_C°C)"
    fi
fi

echo "$LOG_PREFIX OK: All checks passed"
exit 0
